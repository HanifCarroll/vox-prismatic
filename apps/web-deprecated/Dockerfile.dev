FROM node:22 AS base

# Use JS implementation for Rollup to avoid native optional binaries
ENV ROLLUP_DISABLE_NATIVE=1 \
    ROLLUP_SKIP_NODEJS_NATIVE=1

RUN corepack enable && corepack prepare pnpm@9.7.0 --activate || npm i -g pnpm@9

WORKDIR /repo

# Layer 1: install dependencies with maximum cache reuse
FROM base AS deps
WORKDIR /repo

# Copy workspace manifests for caching
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml ./
COPY apps/web-deprecated/package.json apps/web-deprecated/package.json

# Install full workspace deps (no code yet, but enough for linking)
# Use non-frozen lockfile in dev to tolerate local changes without manual lock regen
RUN pnpm install --no-frozen-lockfile

# Stage: runner with prebaked node_modules available for hydration
FROM base AS runner
WORKDIR /repo

# Copy prebaked node_modules directories to a safe location not shadowed by bind mounts
COPY --from=deps /repo/node_modules /opt/dev-deps/root_node_modules
COPY --from=deps /repo/apps/web-deprecated/node_modules /opt/dev-deps/web_node_modules

# Provide a small entrypoint that hydrates the mounted node_modules volumes if empty
COPY apps/web-deprecated/docker/dev-entrypoint.sh /usr/local/bin/dev-entrypoint.sh
RUN chmod +x /usr/local/bin/dev-entrypoint.sh

# Default command runs the entrypoint which hydrates and starts Vite
CMD ["/usr/local/bin/dev-entrypoint.sh"]
