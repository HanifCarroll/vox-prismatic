import{c as E,r as g,u as L,d as R,e as U,j as e,f as y,B as m,g as k,t as C,h as O}from"./main-wPaknWIa.js";import{B as F}from"./badge-CRvqHR08.js";import{C as D,a as T,b as z,c as I}from"./card-BAQmJubA.js";import{S as q,a as B,b as M,c as H,d as P,f as w}from"./formatDistanceToNow-RkJzJ227.js";import{T as $,a as Q,b as N,c as j,d as V,e as h}from"./table-ByumDcZc.js";import{D as _,a as K,b as G,c as J,d as W,e as X}from"./dialog-DmYRCcAd.js";import{I as Y,T as Z}from"./textarea-CJFim08h.js";import"./index-CmZwSi2v.js";import"./en-US-DIdCsyf3.js";const ee=[{value:"7d",label:"Last 7 days"},{value:"30d",label:"Last 30 days"},{value:"all",label:"All time"}];function te(t){if(t==="all")return{};const a=new Date,n=new Date;return t==="7d"?n.setDate(a.getDate()-7):n.setDate(a.getDate()-30),{from:n.toISOString(),to:a.toISOString()}}function he(){const t=E.useLoaderData(),[a,n]=g.useState("30d"),c=L(),o=R(),u=U({queryKey:["admin","usage",a],queryFn:async()=>{const s=te(a);return O(s)},initialData:()=>a==="30d"?t.initialUsage:void 0}),l=u.data?.usage??[],r=u.isLoading||u.isFetching,x=g.useMemo(()=>{const s=l.reduce((d,b)=>d+b.totalCostUsd,0),f=l.reduce((d,b)=>d+b.totalActions,0),v=l.filter(d=>d.subscriptionStatus==="active").length,i=l.filter(d=>d.trialEndsAt?d.trialEndsAt.getTime()>Date.now():!1).length;return{totalSpend:s,totalActions:f,activeSubscriptions:v,trialing:i}},[l]);return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold mb-2",children:"Admin dashboard"}),e.jsx("p",{className:"text-zinc-600",children:"Track AI usage costs, subscriptions, and trials."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4",children:[e.jsx(p,{label:"Total spend",value:y(x.totalSpend),isLoading:r}),e.jsx(p,{label:"Total AI actions",value:x.totalActions.toLocaleString(),isLoading:r}),e.jsx(p,{label:"Active subscriptions",value:x.activeSubscriptions.toString(),isLoading:r}),e.jsx(p,{label:"Active trials",value:x.trialing.toString(),isLoading:r})]}),e.jsxs(D,{children:[e.jsxs(T,{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx(z,{children:"User usage overview"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Select a range to inspect aggregate usage and manage trials."})]}),e.jsxs(q,{value:a,onValueChange:s=>n(s),children:[e.jsx(B,{className:"w-48",children:e.jsx(M,{placeholder:"Select range"})}),e.jsx(H,{children:ee.map(s=>e.jsx(P,{value:s.value,children:s.label},s.value))})]})]}),e.jsx(I,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs($,{children:[e.jsx(Q,{children:e.jsxs(N,{children:[e.jsx(j,{children:"User"}),e.jsx(j,{children:"Usage"}),e.jsx(j,{children:"Last action"}),e.jsx(j,{children:"Subscription"}),e.jsx(j,{children:"Trial"}),e.jsx(j,{className:"text-right",children:"Actions"})]})}),e.jsx(V,{children:l.length===0?e.jsx(N,{children:e.jsx(h,{colSpan:6,className:"text-center text-sm text-zinc-500 py-8",children:r?"Loading usage…":"No usage recorded for this period yet."})}):l.map(s=>e.jsxs(N,{children:[e.jsxs(h,{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-zinc-500",children:s.email})]}),e.jsxs(h,{children:[e.jsx("div",{className:"font-medium",children:y(s.totalCostUsd)}),e.jsxs("div",{className:"text-xs text-zinc-500",children:[s.totalActions.toLocaleString()," actions"]})]}),e.jsx(h,{children:s.lastActionAt?e.jsx("div",{className:"text-sm",children:w(s.lastActionAt,{addSuffix:!0})}):e.jsx("div",{className:"text-sm text-zinc-500",children:"No usage yet"})}),e.jsx(h,{children:e.jsx(se,{summary:s})}),e.jsx(h,{children:e.jsx(ae,{summary:s})}),e.jsx(h,{className:"text-right",children:e.jsx(ie,{summary:s,onUpdated:async()=>{await u.refetch(),c.user?.id===s.userId&&await c.refresh(),await o.invalidateQueries({queryKey:["admin","usage"]})}})})]},s.userId))})]})})})]})]})}function p({label:t,value:a,isLoading:n}){return e.jsxs(D,{children:[e.jsx(T,{className:"pb-2",children:e.jsx(z,{className:"text-sm text-zinc-500 font-medium",children:t})}),e.jsx(I,{children:e.jsx("div",{className:"text-2xl font-semibold text-zinc-900",children:n?e.jsx("span",{className:"text-base text-zinc-400",children:"Loading…"}):a})})]})}function se({summary:t}){const a=t.subscriptionStatus,n=t.subscriptionCurrentPeriodEnd,c=a.replace(/_/g," "),o=a==="active"?"default":a==="past_due"?"destructive":"secondary";return e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsx(F,{variant:o,children:c}),n?e.jsxs("div",{className:"text-xs text-zinc-500",children:["Renews ",n.toLocaleDateString()]}):null,t.cancelAtPeriodEnd?e.jsx("div",{className:"text-xs text-amber-600",children:"Cancels at period end"}):null,t.stripeCustomerId?e.jsxs("div",{className:"text-xs text-zinc-500",children:["Customer ID ",t.stripeCustomerId]}):e.jsx("div",{className:"text-xs text-zinc-500",children:"Not yet subscribed"})]})}function ae({summary:t}){if(!t.trialEndsAt)return e.jsx("span",{className:"text-sm text-zinc-500",children:"No active trial"});const a=Date.now(),c=t.trialEndsAt.getTime()-a>0;return e.jsxs("div",{className:"text-sm text-zinc-600 space-y-1",children:[e.jsxs("div",{children:[c?"Ends ":"Ended ",w(t.trialEndsAt,{addSuffix:!0})]}),t.trialNotes?e.jsx("div",{className:"text-xs text-zinc-500 whitespace-pre-wrap",children:t.trialNotes}):null]})}function ie({summary:t,onUpdated:a}){const[n,c]=g.useState(!1),[o,u]=g.useState(!1),[l,r]=g.useState(()=>S(t.trialEndsAt)),[x,s]=g.useState(t.trialNotes??""),f=()=>{r(""),s("")},v=async()=>{try{u(!0);const i={trialEndsAt:l?new Date(l):null,trialNotes:x.trim()?x.trim():null};await k(t.userId,{data:i}),C.success("Trial updated"),await a(),c(!1)}catch(i){const d=i&&typeof i=="object"&&"error"in i&&typeof i.error=="string"?i.error:"Failed to update trial";C.error(d)}finally{u(!1)}};return e.jsxs(_,{open:n,onOpenChange:i=>!o&&c(i),children:[e.jsx(K,{asChild:!0,children:e.jsx(m,{variant:"outline",size:"sm",children:"Manage trial"})}),e.jsxs(G,{children:[e.jsx(J,{children:e.jsxs(W,{children:["Update trial for ",t.name]})}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-zinc-700",htmlFor:`trial-${t.userId}`,children:"Trial end"}),e.jsx(Y,{id:`trial-${t.userId}`,type:"datetime-local",value:l,onChange:i=>r(i.target.value)}),e.jsxs("div",{className:"flex gap-2 text-xs text-zinc-500",children:[e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>r(S(A(7))),children:"+7 days"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>r(S(A(14))),children:"+14 days"}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"h-8 px-2 text-xs",onClick:()=>r(""),children:"Clear"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-zinc-700",htmlFor:`notes-${t.userId}`,children:"Notes (optional)"}),e.jsx(Z,{id:`notes-${t.userId}`,rows:4,value:x,onChange:i=>s(i.target.value),placeholder:"Reason for trial, duration, or internal notes"})]})]}),e.jsxs(X,{className:"flex flex-col sm:flex-row sm:justify-between gap-2",children:[e.jsx(m,{type:"button",variant:"ghost",className:"sm:mr-auto",onClick:f,disabled:o,children:"Reset"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{variant:"outline",type:"button",onClick:()=>c(!1),disabled:o,children:"Cancel"}),e.jsx(m,{type:"button",onClick:v,disabled:o,children:o?"Saving…":"Save changes"})]})]})]})]})}function A(t){const a=new Date;return a.setDate(a.getDate()+t),a}function S(t){return t?new Date(t).toISOString().slice(0,16):""}export{he as component};
