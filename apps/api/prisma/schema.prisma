generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Transcript {
  id             String    @id @default(cuid())
  title          String
  rawContent     String    @map("raw_content")
  cleanedContent String?   @map("cleaned_content")
  status         String    @default("raw")
  sourceType     String?   @map("source_type")
  sourceUrl      String?   @map("source_url")
  fileName       String?   @map("file_name")
  duration       Int?
  wordCount      Int       @default(0) @map("word_count")
  filePath       String?   @map("file_path")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  queueJobId     String?   @map("queue_job_id")
  errorMessage   String?   @map("error_message")
  failedAt       DateTime? @map("failed_at")
  insights       Insight[]

  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt(sort: Desc)])
  @@index([sourceType, status])
  @@map("transcripts")
}

model Insight {
  id                   String     @id @default(cuid())
  cleanedTranscriptId  String     @map("cleaned_transcript_id")
  title                String
  summary              String
  verbatimQuote        String     @map("verbatim_quote")
  category             String
  postType             String     @map("post_type")
  urgencyScore         Int        @map("urgency_score")
  relatabilityScore    Int        @map("relatability_score")
  specificityScore     Int        @map("specificity_score")
  authorityScore       Int        @map("authority_score")
  totalScore           Int        @map("total_score")
  status               String     @default("draft")
  processingDurationMs Int?       @map("processing_duration_ms")
  estimatedTokens      Int?       @map("estimated_tokens")
  estimatedCost        Float?     @map("estimated_cost")
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")
  queueJobId           String?    @map("queue_job_id")
  reviewedBy           String?    @map("reviewed_by")
  reviewedAt           DateTime?  @map("reviewed_at")
  rejectionReason      String?    @map("rejection_reason")
  approvedBy           String?    @map("approved_by")
  approvedAt           DateTime?  @map("approved_at")
  archivedBy           String?    @map("archived_by")
  archivedAt           DateTime?  @map("archived_at")
  archivedReason       String?    @map("archived_reason")
  failureReason        String?    @map("failure_reason")
  failedAt             DateTime?  @map("failed_at")
  retryCount           Int        @default(0) @map("retry_count")
  transcript           Transcript @relation(fields: [cleanedTranscriptId], references: [id], onDelete: Cascade)
  posts                Post[]

  @@index([cleanedTranscriptId])
  @@index([status])
  @@index([totalScore])
  @@index([createdAt])
  @@index([status, totalScore(sort: Desc)])
  @@index([cleanedTranscriptId, status])
  @@index([category, postType])
  @@index([status, createdAt(sort: Desc)])
  @@index([category, status, totalScore(sort: Desc)])
  @@map("insights")
}

model Post {
  id             String          @id @default(cuid())
  insightId      String          @map("insight_id")
  title          String
  platform       String
  content        String
  status         String          @default("draft")
  characterCount Int?            @map("character_count")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  queueJobId     String?         @map("queue_job_id") // BullMQ job ID for generation tracking
  errorMessage   String?         @map("error_message")
  rejectedAt     DateTime?       @map("rejected_at")
  rejectedBy     String?         @map("rejected_by")
  rejectedReason String?         @map("rejected_reason")
  approvedAt     DateTime?       @map("approved_at")
  approvedBy     String?         @map("approved_by")
  archivedAt     DateTime?       @map("archived_at")
  archivedReason String?         @map("archived_reason")
  failedAt       DateTime?       @map("failed_at")
  insight        Insight         @relation(fields: [insightId], references: [id], onDelete: Cascade)
  scheduledPosts ScheduledPost[]

  @@index([insightId])
  @@index([platform])
  @@index([status])
  @@index([createdAt])
  @@index([platform, status, createdAt(sort: Desc)])
  @@index([insightId, status])
  @@index([status, createdAt(sort: Desc)])
  @@index([platform, status])
  @@index([queueJobId])
  @@map("posts")
}

model ScheduledPost {
  id             String    @id @default(cuid())
  postId         String    @map("post_id")
  platform       String
  content        String
  scheduledTime  DateTime  @map("scheduled_time")
  status         String    @default("pending")
  retryCount     Int       @default(0) @map("retry_count")
  lastAttempt    DateTime? @map("last_attempt")
  errorMessage   String?   @map("error_message")
  externalPostId String?   @map("external_post_id")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  queueJobId     String?   @map("queue_job_id")
  post           Post      @relation(fields: [postId], references: [id])

  @@index([postId])
  @@index([platform])
  @@index([status])
  @@index([scheduledTime])
  @@index([createdAt])
  @@index([queueJobId])
  @@index([status, scheduledTime])
  @@index([platform, status])
  @@index([scheduledTime, status])
  @@index([status, createdAt(sort: Desc)])
  @@map("scheduled_posts")
}

model ProcessingJob {
  id              String   @id @default(cuid())
  jobType         String   @map("job_type")
  sourceId        String   @map("source_id")
  status          String   @default("queued")
  progress        Int      @default(0)
  resultCount     Int      @default(0) @map("result_count")
  errorMessage    String?  @map("error_message")
  startedAt       String?  @map("started_at")
  completedAt     String?  @map("completed_at")
  durationMs      Int?     @map("duration_ms")
  estimatedTokens Int?     @map("estimated_tokens")
  estimatedCost   Float?   @map("estimated_cost")
  retryCount      Int      @default(0) @map("retry_count")
  maxRetries      Int?     @map("max_retries")
  lastError       Json?    @map("last_error")
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([jobType, status])
  @@index([sourceId])
  @@index([status])
  @@index([createdAt])
  @@index([status, startedAt])
  @@map("processing_jobs")
}

model Setting {
  key         String   @id
  value       String
  category    String   @default("general")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("settings")
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventType  String   @map("event_type")
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  eventData  String?  @map("event_data")
  value      Float?
  occurredAt DateTime @map("occurred_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("analytics_events")
}

model Pipeline {
  id                 String    @id @default(cuid())
  transcriptId       String    @map("transcript_id")
  state              String    @default("idle")
  currentStep        String?   @map("current_step")
  totalSteps         Int       @default(0) @map("total_steps")
  completedSteps     Int       @default(0) @map("completed_steps")
  progress           Int       @default(0)
  template           String    @default("standard")
  options            Json?
  insightIds         String[]  @map("insight_ids")
  postIds            String[]  @map("post_ids")
  failedSteps        Json?     @map("failed_steps")
  successfulSteps    Json?     @map("successful_steps")
  blockingItems      Json?     @map("blocking_items")
  metadata           Json?
  estimatedDuration  Int?      @map("estimated_duration_ms")
  actualDuration     Int?      @map("actual_duration_ms")
  startedAt          DateTime? @map("started_at")
  pausedAt           DateTime? @map("paused_at")
  completedAt        DateTime? @map("completed_at")
  failedAt           DateTime? @map("failed_at")
  lastError          String?   @map("last_error")
  retryCount         Int       @default(0) @map("retry_count")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@index([transcriptId])
  @@index([state])
  @@index([template])
  @@index([createdAt])
  @@index([state, createdAt(sort: Desc)])
  @@map("pipelines")
}
